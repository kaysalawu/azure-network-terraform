## 1. Private DNS Zones, Vnet links and DNS Auto-registration <!-- omit from toc -->

MicroHack MH51: Private DNS - Secured Virtual WAN (Dual Region) <!-- omit from toc -->

[← Previous](../README.md)

Contents

- [list in a table format the dns zones create and auto-registration status](#list-in-a-table-format-the-dns-zones-create-and-auto-registration-status)
      - [Step 2: Create Private DNS zones](#step-2-create-private-dns-zones)


## Overview

In this exercise we will create private DNS zones for each spoke and link them to the virtual network. We will also enable DNS auto-registration for the virtual network.

![mh51-1-private-dns-zones-links-config](../../images/../../images/microhacks/mh51/mh51-1-private-dns-zones-links-config.png)

### Task 1: Create Private DNS zones

A private DNS zone is used to host the DNS records for a particular domain. Each DNS record for your domain is then created inside this DNS zone. In this microhack, we assume that each spoke is a Business Unit (BU) of an organisation and each BU requires its own private DNS zone.

We will now create the private DNS zones for each spoke.

1. Ensure you that you have set up and logged into [Cloud Shell](https://learn.microsoft.com/en-us/azure/cloud-shell/overview) and met the requirements in the [pre-requisites](../../../prerequisites/README.md).

2. Save the resource group name in an environment variable.

   ```bash
   export RG_NAME=Vwan_DnsRG
   ```

3. Create the private DNS zones.

   ```bash
   az network private-dns zone create -g $RG_NAME -n spoke1.eu.az.corp
   az network private-dns zone create -g $RG_NAME -n spoke2.eu.az.corp
   az network private-dns zone create -g $RG_NAME -n spoke3.eu.az.corp
   az network private-dns zone create -g $RG_NAME -n spoke4.eu.az.corp
   ```

### Task 2: Create Spoke Vnet links and enable DNS auto-registration

To publish a private DNS zone to your virtual network, you specify the list of virtual networks that are allowed to resolve records within the zone. This is done by creating a virtual network link between the DNS zone and the virtual network.

1. Create Vnet links with auto-registration from the DNS zones to the spoke virtual networks.

   ```bash
   command="az network private-dns link vnet create -g $RG_NAME -e true"
   $command -n spoke1-vnet-link -z spoke1.eu.az.corp -v Vwan_Dns-spoke1-vnet
   $command -n spoke2-vnet-link -z spoke2.eu.az.corp -v Vwan_Dns-spoke2-vnet
   $command -n spoke3-vnet-link -z spoke3.eu.az.corp -v Vwan_Dns-spoke3-vnet
   $command -n spoke4-vnet-link -z spoke4.eu.az.corp -v Vwan_Dns-spoke4-vnet
   ```

2. Create Vnet links from region1 DNS zones to region1 shared services Vnet.

   ```bash
   command="az network private-dns link vnet create -g $RG_NAME -e false"
   $command -n shared1-spoke1-vnet-link -z spoke1.eu.az.corp -v Vwan_Dns-shared1-vnet
   $command -n shared1-spoke2-vnet-link -z spoke2.eu.az.corp -v Vwan_Dns-shared1-vnet
   ```

3. Create Vnet links from region2 DNS zones to region2 shared services Vnet.

   ```bash
   command="az network private-dns link vnet create -g $RG_NAME -e false"
   $command -n shared2-spoke3-vnet-link -z spoke3.eu.az.corp -v Vwan_Dns-shared2-vnet
   $command -n shared2-spoke4-vnet-link -z spoke4.eu.az.corp -v Vwan_Dns-shared2-vnet
   ```

4. Verify the created DNS zones.

   ```bash
   az network private-dns zone list -g $RG_NAME -o table \
   --query "[].{ZoneName:name, \
   RecordSets: numberOfRecordSets, \
   provisioningState: provisioningState, \
   VnetLinks: numberOfVirtualNetworkLinks, \
   VnetAutoRegistrationLinks: numberOfVirtualNetworkLinksWithRegistration}"
   ```

   Sample output:

   ```sh
   ZoneName           RecordSets    ProvisioningState    VnetLinks    VnetAutoRegistrationLinks
   -----------------  ------------  -------------------  -----------  -----------------------
   spoke1.eu.az.corp  2             Succeeded            2            1
   spoke2.eu.az.corp  2             Succeeded            2            1
   spoke3.eu.az.corp  2             Succeeded            2            1
   spoke4.eu.az.corp  2             Succeeded            2            1
   ```

#### Task 3: Test DNS Resolution in Spoke1 VM

Each virtual machine is pre-configured with a shell [script](../../../scripts/server.sh) to run various types of network reachability tests. Serial console access has been configured for all virtual machines. You can [access the serial console](https://learn.microsoft.com/en-us/troubleshoot/azure/virtual-machines/serial-console-overview#access-serial-console-for-virtual-machines-via-azure-portal) of a virtual machine from the Azure portal.

![mh51-1-private-dns-zones-links-test](../../images/../../images/microhacks/mh51/mh51-1-private-dns-zones-links-test.png)

Login to virtual machine `Vwan_Dns-spoke1-vm` via the serial console:

- On Azure portal select *Virtual machines*
- Select the virtual machine `Vwan_Dns-spoke1-vm`
- Under ***Help*** section, select ***Serial console*** and wait for a login prompt
- Enter the login credentials
  - username = ***azureuser***
  - password = ***Password123***
- You should now be in a shell session `azureuser@VwanDns-spoke1-vm:~$`

Run the following tests from inside the serial console session.

1. Run a DNS lookup for the private DNS zone `spoke1.eu.az.corp`

   ```sh
   nslookup spoke1.eu.az.corp
   ```

   Sample output:

   ```sh
   azureuser@vm:~$ nslookup vm.spoke1.eu.az.corp
   Server:         127.0.0.53
   Address:        127.0.0.53#53

   Non-authoritative answer:
   Name:   vm.spoke1.eu.az.corp
   Address: 10.1.0.5
   ```

2. Run a DNS lookup for the private DNS zone `spoke2.eu.az.corp`

   ```sh
    nslookup vm.spoke2.eu.az.corp
    ```
    Sample output:

   ```sh
   azureuser@vm:~$ nslookup vm.spoke2.eu.az.corp
   Server:         127.0.0.53
   Address:        127.0.0.53#53

   ** server can't find vm.spoke2.eu.az.corp: NXDOMAIN
   ```

   The `NXDOMAIN` error is expected as the DNS zone `spoke2.eu.az.corp` is not linked to the spoke2 virtual network.

3. Run the `ping-dns` test script to check DNS resolution to all virtual machines.

    ```sh
    ping-dns
    ```

    Sample output:

    ```sh
   azureuser@vm:~$ ping-dns

   ping dns ...

   vm.branch1.corp -  -NA
   vm.spoke1.eu.az.corp - 10.1.0.5 -OK 0.036 ms
   vm.spoke2.eu.az.corp -  -NA
   vm.branch2.corp -  -NA
   vm.spoke3.eu.az.corp -  -NA
   vm.spoke4.us.az.corp -  -NA
   icanhazip.com - 104.18.114.97 -NA
   ```
The script confirms that `Vwan_Dns-spoke1-vm` can only resolve spoke DNS zone and public DNS names (e.g. icanhazip.com) via the Azure DNS service. All other spokes and the on-premises branches are not resolvable.

## Congratulations! <!-- omit from toc -->

You have completed this exercise. You have created private DNS zones for each spoke and linked them to virtual networks. You have also enabled DNS auto-registration for virtual networks.

## NEXT STEP <!-- omit from toc -->
Go to exercise [2. DNS Resolution between On-premises and Azure](./2.%20DNS%20Resolution%20between%20On-premises%20and%20Azure.md)

[← Previous](../README.md) | [Next →](./2.%20DNS%20Resolution%20between%20On-premises%20and%20Azure.md)
