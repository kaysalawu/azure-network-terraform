#cloud-config

package_update: true
package_upgrade: true
packages:
  - docker.io
  - docker-compose
  - dnsutils
  - net-tools

write_files:
  - path: /etc/squid/blocked_sites
    owner: root
    permissions: 0744
    content: |
      google.com
      bbc.co.uk
      
  - path: /etc/squid/squid.conf
    owner: root
    permissions: 0744
    content: |
      # squid.conf
      http_port 3128
      
      acl blocked_sites dstdomain "/etc/squid/blocked_sites"
      http_access deny blocked_sites
      
      http_access allow all
      
      # Enable logging
      access_log /var/log/squid/access.log squid
      cache_log /var/log/squid/cache.log
      cache_store_log /var/log/squid/store.log
      
  - path: /etc/unbound/unbound.conf
    owner: root
    permissions: 0744
    content: |
      
      server:
          interface: 0.0.0.0
      
          access-control: 0.0.0.0 deny
          access-control: 127.0.0.0/8 allow
          access-control: 10.0.0.0/8 allow
          access-control: 192.168.0.0/16 allow
          access-control: 172.16.0.0/12 allow
          access-control: 35.199.192.0/19 allow
      
          local-data: "webd1.corp.sap.com 3600 IN A 10.0.3.4"
          local-data: "webd2.corp.sap.com 3600 IN A 10.0.3.5"
          local-data: "appsrv1.corp.sap.com 3600 IN A 10.0.3.6"
          local-data: "appsrv2.corp.sap.com 3600 IN A 10.0.3.7"
          local-data: "ecscgs.corp.sap.com 3600 IN A 10.0.3.8"
          local-data: "ilb.corp.sap.com 3600 IN A 10.0.3.99"
      
      forward-zone:
          name: "."
          forward-addr: 168.63.129.16
      
  - path: /var/lib/labs/squid/docker-compose.yml
    owner: root
    permissions: 0744
    content: |
      version: '3.7'
      services:
        squid:
          container_name: squid
          image: ubuntu/squid:latest
          ports:
            - "3128:3128"
          network_mode: "host"
          volumes:
            - /etc/squid/squid.conf:/etc/squid/squid.conf
            - /etc/squid/blocked_sites:/etc/squid/blocked_sites
            - /var/log/squid/access.log:/var/log/squid/access.log
            - /var/log/squid/cache.log:/var/log/squid/cache.log
            - /var/log/squid/store.log:/var/log/squid/store.log
          restart: always
      
  - path: /var/lib/labs/unbound/Dockerfile
    owner: root
    permissions: 0744
    content: |
      FROM alpine:3.19.0
      RUN apk add --no-cache unbound
      EXPOSE 53/tcp 53/udp
      CMD ["unbound", "-d"]
      
  - path: /var/lib/labs/unbound/docker-compose.yml
    owner: root
    permissions: 0744
    content: |
      version: '3'
      
      services:
        unbound:
          container_name: unbound
          build:
            context: .
            dockerfile: Dockerfile
          ports:
            - "53:53/tcp"
            - "53:53/udp"
          network_mode: "host"
          volumes:
            - /etc/unbound/unbound.log:/etc/unbound/unbound.log
            - /etc/unbound/unbound.conf:/etc/unbound/unbound.conf
          cap_add:
            - NET_ADMIN
          command: ["unbound", "-d"]
          restart: always
      

runcmd:
  - systemctl stop systemd-resolved
  - systemctl disable systemd-resolved
  - echo "nameserver 8.8.8.8" > /etc/resolv.conf
  - systemctl restart unbound
  - systemctl enable unbound
  - docker-compose -f /var/lib/labs/unbound/docker-compose.yml up -d
  - docker-compose -f /var/lib/labs/squid/docker-compose.yml up -d
