#cloud-config

package_update: true
package_upgrade: true
packages:
  - docker.io
  - docker-compose
  - dnsutils
  - net-tools

write_files:
  - path: /etc/squid/blocked_sites
    owner: root
    permissions: 0744
    content: |
      google.com
      bbc.co.uk
      
  - path: /etc/squid/squid.conf
    owner: root
    permissions: 0744
    content: |
      # squid.conf
      http_port 3128
      
      acl blocked_sites dstdomain "/etc/squid/blocked_sites"
      http_access deny blocked_sites
      
      http_access allow all
      
      # Enable logging
      access_log /var/log/squid/access.log squid
      cache_log /var/log/squid/cache.log
      cache_store_log /var/log/squid/store.log
      
  - path: /etc/unbound/unbound.conf
    owner: root
    permissions: 0744
    content: |
      
      server:
          interface: 0.0.0.0
      
          access-control: 0.0.0.0 deny
          access-control: 127.0.0.0/8 allow
          access-control: 10.0.0.0/8 allow
          access-control: 192.168.0.0/16 allow
          access-control: 172.16.0.0/12 allow
          access-control: 35.199.192.0/19 allow
      
          local-data: "server1.eu.az.corp 3600 IN A 10.0.3.4"
          local-data: "server2.eu.az.corp 3600 IN A 10.0.3.5"
          local-data: "proxy.eu.az.corp 3600 IN A 10.0.2.4"
      
      forward-zone:
          name: "."
          forward-addr: 168.63.129.16
      
  - path: /var/lib/azure/crawler/app/crawler.sh
    owner: root
    permissions: 0744
    content: |
      #!/bin/bash
      
      char_pass="\u2714"
      char_fail="\u274c"
      char_question="\u2753"
      char_notfound="\u26D4"
      char_exclamation="\u2757"
      char_celebrate="\u2B50"
      char_executing="\u23F3"
      
      bold=$(tput bold)
      color_green=$(tput setaf 2)
      color_red=$(tput setaf 1)
      reset=$(tput sgr0)
      
      export ETH0_IP=$(hostname -I | awk '{print $1}')
      echo -e "\nExtracting az token..."
      export TOKEN=$(timeout 5 az account get-access-token --query accessToken -o tsv 2>/dev/null)
      echo -e "Downloading service tags JSON..."
      if [ ! -f service_tags.json ]; then
        curl -o service_tags.json "https://download.microsoft.com/download/7/1/D/71D86715-5596-4529-9B13-DA13A5DE5B63/ServiceTags_Public_20240318.json" 2>/dev/null
      fi
      
      echo -e "\n-------------------------------------"
      echo -e "Environment"
      echo -e "-------------------------------------"
      echo "VM Name:        Lab10-Proxy"
      echo "Resource Group: Lab10_NetworkEgress_RG"
      echo "Location:       northeurope"
      echo "VNET Name:      Lab10-hub-vnet"
      echo "Subnet Name:    PublicSubnet"
      echo "Private IP:     $ETH0_IP"
      echo -e "-------------------------------------"
      
      declare -a PUBLIC_ADDRESS_TYPE
      declare -a SERVICE_ENDPOINTS
      declare -a PRIVATE_SUBNET
      declare -a INTERNET_ACCESS
      declare -a MANAGEMENT_ACCESS
      declare -a BLOB_ACCESS
      declare -a KEYVAULT_ACCESS
      
      function resolve_dns() {
        local host=$1
        dns_result=$(host "$host" 2>/dev/null)
        if echo "$dns_result" | grep -q "has address"; then
          ip_address=$(echo "$dns_result" | awk '/has address/ { print $4 }' | head -n 1)
          echo -e "   $ip_address <-- $host"
        else
          echo -e "   $dns_result"
        fi
      }
      
      function get_azure_service_tag_from_host() {
        local host=$1
        local ip_address=$(host "$host" | awk '/has address/ { print $4 }' | head -n 1 2>/dev/null)
        echo -e "   Searching for service tags matching IP ($ip_address)"
        python3 service_tags.py "$ip_address" "service_tags.json" 2>/dev/null
      }
      
      function check_address_type() {
        #####################################################
        echo -e "\n1. Check Public Address Type"
        #####################################################
        local internet_url="http://ifconfig.me/ip"
        local public_ip=$(timeout 5 curl -s $internet_url)
        echo -e "   Local IP:\t$ETH0_IP"
        echo -e "   Public IP:\t$public_ip"
      
        ips=$(timeout 5 az network public-ip list -g Lab10_NetworkEgress_RG --query "[].{ip:ipAddress, name:name, id:id}" -o tsv 2>/dev/null)
        local found=0
        while IFS= read -r line; do
            ip=$(echo $line | awk '{print $1}')
            name=$(echo $line | awk '{print $2}')
            id=$(echo $line | awk '{print $3}')
      
            if [[ "$ip" == "$public_ip" ]]; then
                if [[ $name == *"snat-feip-pip"* ]]; then
                    echo -e "   Address type: SnatIP"
                    PUBLIC_ADDRESS_TYPE=("SnatIP")
                elif [[ $name == *"natgw-pip"* ]]; then
                    echo -e "   Address type: NatGw"
                    PUBLIC_ADDRESS_TYPE=("NatGw")
                elif [[ $name == *"nic-pip"* ]]; then
                    echo -e "   Address type: VmPublicIp"
                    PUBLIC_ADDRESS_TYPE=("VmPublicIp")
                else
                    echo -e "   Address type: None"
                    PUBLIC_ADDRESS_TYPE=("None")
                fi
                found=1
                break
            fi
        done <<< "$ips"
      
        if [[ $found -eq 0 ]]; then
            PUBLIC_ADDRESS_TYPE=("None")
            echo -e "   NAT_IP type:\tNone"
        fi
      }
      
      function check_service_endpoints() {
        subnet=$1
        #####################################################
        echo -e "\n2. Check Service Endpoints"
        #####################################################
        echo -e "   Subnet --> PublicSubnet"
        if ! service_endpoints=$(timeout 5 az network vnet subnet show -g Lab10_NetworkEgress_RG --vnet-name Lab10-hub-vnet --name "PublicSubnet" --query "serviceEndpoints[].service" -o tsv 2>/dev/null); then
        echo -e "   Service Endpoint: Timed out!"
        SERVICE_ENDPOINTS=("Timed out!")
        elif [ -z "$service_endpoints" ]; then
          echo -e "   Service Endpoint: Disabled"
          SERVICE_ENDPOINTS=("Disabled")
        else
          echo -e "   Service Endpoint: Enabled"
          echo "$service_endpoints" | tr '\t' '\n' | awk '{print "   - " $0}'
          SERVICE_ENDPOINTS=("Enabled")
        fi
      }
      
      function check_private_subnet() {
        #####################################################
        echo -e "\n3. Check Private Subnet"
        #####################################################
        echo -e "   Subnet --> PublicSubnet"
        if ! default_outbound_access=$(timeout 5 az network vnet subnet list --resource-group Lab10_NetworkEgress_RG --vnet-name Lab10-hub-vnet --query "[?name=='PublicSubnet'].defaultOutboundAccess" -o tsv 2>/dev/null); then
          echo -e "   DefaultOutbound: Timed out!"
          default_outbound_access="Timed out!"
        fi
        if [ "$default_outbound_access" == "Timed out!" ]; then
          echo -e "   Private Subnet:  Timed out!"
          PRIVATE_SUBNET="Timed out!"
        elif [ "$default_outbound_access" == "true" ]; then
          echo -e "   Private Subnet:  Disabled"
          PRIVATE_SUBNET=Disabled
        elif [ "$default_outbound_access" == "false" ]; then
          echo -e "   Private Subnet:  Enabled"
          PRIVATE_SUBNET=Enabled
        else
          echo -e "   Private Subnet:  "
          PRIVATE_SUBNET=
        fi
      }
      
      function check_internet_access() {
        #####################################################
        echo -e "\n4. Check Internet Access"
        #####################################################
        url="https://ifconfig.me"
        echo "   curl $url"
        if ! internet_access_code=$(timeout 5 curl -o /dev/null -s -w "%{http_code}\n" $url); then
          echo -e "   Internet Access: Timed out!"
          INTERNET_ACCESS="Timed out!"
        elif [[ "$internet_access_code" =~ ^2 ]] || [[ "$internet_access_code" =~ ^3 ]]; then
          echo -e "   Internet Access: Pass ($internet_access_code)"
          INTERNET_ACCESS="Pass"
        else
          echo -e "   Internet Access: Fail ($internet_access_code)"
          INTERNET_ACCESS="Fail"
        fi
      }
      
      function check_management_access() {
        #####################################################
        echo -e "\n5. Management (Control Plane)"
        #####################################################
        local host=$(echo https://management.azure.com/subscriptions?api-version=2020-01-01 | awk -F/ '{print $3}')
        echo -e "   url = https://management.azure.com/subscriptions?api-version=2020-01-01"
        echo -e "   host = $host"
        resolve_dns $host 2>/dev/null
        get_azure_service_tag_from_host $host 2>/dev/null
      
        echo -e "   curl -H "Authorization : Bearer TOKEN" https://management.azure.com/subscriptions?api-version=2020-01-01"
        if ! management_access_code=$(timeout 5 curl -o /dev/null -s -w "%{http_code}\n" -H "Authorization : Bearer $TOKEN" https://management.azure.com/subscriptions?api-version=2020-01-01); then
          echo -e "   Management Access: Timed out!"
          MANAGEMENT_ACCESS="Timed out!"
        elif [[ "$management_access_code" =~ ^2 ]] || [[ "$management_access_code" =~ ^3 ]]; then
          echo -e "   Management Access: Pass ($management_access_code)"
          MANAGEMENT_ACCESS="Pass"
        else
          echo -e "   Management Access: Fail ($management_access_code)"
          MANAGEMENT_ACCESS="Fail"
        fi
      }
      
      function download_blob() {
        #####################################################
        echo -e "\n6. Blob (Data Plane)"
        #####################################################
        local host=$(echo https://lab10hub481a.blob.core.windows.net/storage/storage.txt | awk -F/ '{print $3}')
        echo -e "   url = https://lab10hub481a.blob.core.windows.net/storage/storage.txt"
        echo -e "   host = $host"
        resolve_dns $host 2>/dev/null
        get_azure_service_tag_from_host $host 2>/dev/null
        storage_account_key=""
        storage_access_token=""
        blob_access=""
        echo -e "   az storage account keys list -g Lab10_NetworkEgress_RG --account-name lab10hub481a"
        if storage_account_key=$(timeout 5 az storage account keys list -g Lab10_NetworkEgress_RG --account-name lab10hub481a --query "[0].value" -o tsv 2>/dev/null); then
          echo "   az storage blob download --account-name lab10hub481a -c storage -n storage.txt --account-key <KEY>"
          blob_access=$(timeout 5 az storage blob download --account-name lab10hub481a -c storage -n storage.txt --account-key $storage_account_key --query content -o tsv 2>/dev/null)
        else
          echo -e "   Storage account key: timed out!"
          echo -e "   Fallback: Get access token for storage.azure.com via metadata ..."
          if ! storage_access_token=$(timeout 5 curl -H Metadata:true "http://169.254.169.254:80/metadata/identity/oauth2/token?resource=https%3A%2F%2Fstorage.azure.com&api-version=2018-02-01" -s | jq -r .access_token); then
            echo -e "   Storage access token: timed out!"
          else
            echo "   curl https://lab10hub481a.blob.core.windows.net/storage/storage.txt ..."
            blob_access=$(timeout 5 curl -s -H "Cache-Control: no-cache" -H "Pragma: no-cache" -H "x-ms-version: 2019-02-02" -H "Authorization: Bearer $storage_access_token" "https://lab10hub481a.blob.core.windows.net/storage/storage.txt")
          fi
        fi
      
        if [ "$blob_access" = "Hello, World!" ]; then
          echo -e "   Content: $blob_access"
          echo -e "   Blob Dataplane: Pass"
          BLOB_ACCESS=Pass
        else
          echo -e "   Blob Dataplane: Fail"
          BLOB_ACCESS=Fail
        fi
      }
      
      function access_keyvault_secret() {
        #####################################################
        echo -e "\n7. KeyVault (Data Plane)"
        #####################################################
        local host=$(echo https://lab10-hub-kv481a.vault.azure.net/secrets/message | awk -F/ '{print $3}')
        echo -e "   url: https://lab10-hub-kv481a.vault.azure.net/secrets/message"
        echo -e "   host: $host"
        resolve_dns $host
        get_azure_service_tag_from_host $host 2>/dev/null
        secret_value=""
        vault_access_token=""
        echo "   az keyvault secret show --vault-name lab10-hub-kv481a --name message"
        if ! secret_value=$(timeout 5 az keyvault secret show --vault-name lab10-hub-kv481a --name message --query value -o tsv 2>/dev/null); then
          echo -e "   message: timed out!"
          echo -e "   Fallback: Get access token for vault.azure.net via metadata ..."
          if ! vault_access_token=$(timeout 5 curl -H Metadata:true "http://169.254.169.254/metadata/identity/oauth2/token?resource=https%3A%2F%2Fvault.azure.net&api-version=2018-02-01" -s | jq -r .access_token); then
            echo -e "   Vault token: timed out!"
          else
            echo "curl https://lab10-hub-kv481a.vault.azure.net/secrets/message?api-version=7.2"
            secret_value=$(timeout 5 curl -H "Cache-Control: no-cache" -H "Pragma: no-cache" -H "Authorization : Bearer $vault_access_token" "https://lab10-hub-kv481a.vault.azure.net/secrets/message?api-version=7.2" -o secret.txt 2>/dev/null)
          fi
        fi
      
        if [ "$secret_value" = "Hello, World!" ]; then
          echo -e "   message: $secret_value"
          echo -e "   Vault Dataplane: Pass"
          KEYVAULT_ACCESS=Pass
        else
          echo -e "   message: not found!"
          echo -e "   Vault Dataplane: Fail"
          KEYVAULT_ACCESS=Fail
        fi
      }
      
      check_address_type
      check_service_endpoints "PublicSubnet"
      check_private_subnet "PublicSubnet"
      check_internet_access
      check_management_access
      download_blob
      access_keyvault_secret
      
      echo -e "\n-------------------------------------"
      echo -e "Results"
      echo -e "-------------------------------------"
      echo -e "1. NAT IP Type: \t$PUBLIC_ADDRESS_TYPE"
      echo -e "2. Service Endpoints: \t$SERVICE_ENDPOINTS"
      echo -e "3. Private Subnet: \t$PRIVATE_SUBNET"
      echo -e "4. Internet Access: \t$INTERNET_ACCESS"
      echo -e "5. Management Access: \t$MANAGEMENT_ACCESS"
      echo -e "6. Blob Dataplane: \t$BLOB_ACCESS"
      echo -e "7. KeyVault Dataplane: \t$KEYVAULT_ACCESS"
      echo -e "-------------------------------------\n"
      
  - path: /var/lib/azure/crawler/app/requirements.txt
    owner: root
    permissions: 0744
    content: |
      certifi==2024.2.2
      charset-normalizer==3.3.2
      idna==3.6
      requests==2.31.0
      urllib3==2.2.1
      
  - path: /var/lib/azure/crawler/app/service_tags.py
    owner: root
    permissions: 0744
    content: |
      import os
      import sys
      import json
      import ipaddress
      
      with open('service_tags.json', 'r') as file:
          data = json.load(file)
      
      def locate_IP_range(ip_address):
          target_ip = ipaddress.ip_address(ip_address)
          matches = []
      
          for value in data['values']:
              for prefix in value['properties']['addressPrefixes']:
                  if target_ip in ipaddress.ip_network(prefix):
                      matches.append(f"   - {ipaddress.ip_network(prefix)} <-- {value['id']} ({value['properties']['region']})")
      
          for match in matches:
              print(match)
      
      def main():
          if len(sys.argv) < 2:
              print("Usage: python service_tags.py <ip_address>")
              sys.exit(1)
      
          ip_address = sys.argv[1]
          locate_IP_range(ip_address)
      
      if __name__ == "__main__":
          main()
      
  - path: /var/lib/azure/init/server.sh
    owner: root
    permissions: 0744
    content: |
      #! /bin/bash
      
      apt update
      apt install -y python3-pip python3-dev python3-venv unzip jq tcpdump dnsutils net-tools nmap apache2-utils iperf3
      
      pip3 install azure-identity
      pip3 install azure-mgmt-network
      
      apt install -y openvpn network-manager-openvpn
      sudo service network-manager restart
      
      curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
      az login --identity || true
      
      # web server #
      pip3 install Flask requests
      
      mkdir /var/flaskapp
      mkdir /var/flaskapp/flaskapp
      mkdir /var/flaskapp/flaskapp/static
      mkdir /var/flaskapp/flaskapp/templates
      
      cat <<EOF > /var/flaskapp/flaskapp/__init__.py
      import socket
      from flask import Flask, request
      app = Flask(__name__)
      
      @app.route("/")
      def default():
          hostname = socket.gethostname()
          address = socket.gethostbyname(hostname)
          data_dict = {}
          data_dict['Hostname'] = hostname
          data_dict['Local-IP'] = address
          data_dict['Remote-IP'] = request.remote_addr
          data_dict['Headers'] = dict(request.headers)
          return data_dict
      
      @app.route("/path1")
      def path1():
          hostname = socket.gethostname()
          address = socket.gethostbyname(hostname)
          data_dict = {}
          data_dict['app'] = 'PATH1-APP'
          data_dict['Hostname'] = hostname
          data_dict['Local-IP'] = address
          data_dict['Remote-IP'] = request.remote_addr
          data_dict['Headers'] = dict(request.headers)
          return data_dict
      
      @app.route("/path2")
      def path2():
          hostname = socket.gethostname()
          address = socket.gethostbyname(hostname)
          data_dict = {}
          data_dict['app'] = 'PATH2-APP'
          data_dict['Hostname'] = hostname
          data_dict['Local-IP'] = address
          data_dict['Remote-IP'] = request.remote_addr
          data_dict['Headers'] = dict(request.headers)
          return data_dict
      
      if __name__ == "__main__":
          app.run(host= '0.0.0.0', port=80, debug = True)
      EOF
      
      cat <<EOF > /etc/systemd/system/flaskapp.service
      [Unit]
      Description=Script for flaskapp service
      
      [Service]
      Type=simple
      ExecStart=/usr/bin/python3 /var/flaskapp/flaskapp/__init__.py
      ExecStop=/usr/bin/pkill -f /var/flaskapp/flaskapp/__init__.py
      StandardOutput=journal
      
      [Install]
      WantedBy=multi-user.target
      EOF
      
      systemctl daemon-reload
      systemctl enable flaskapp.service
      systemctl start flaskapp.service
      
      # test scripts
      #-----------------------------------
      
      # ping-ip
      
      cat <<EOF > /usr/local/bin/ping-ip
      echo -e "\n ping ip ...\n"
      echo "internet - contoso.com -\$(timeout 3 ping -qc2 -W1 contoso.com 2>&1 | awk -F'/' 'END{ print (/^rtt/? "OK "\$5" ms":"NA") }')"
      EOF
      chmod a+x /usr/local/bin/ping-ip
      
      # ping-dns
      
      cat <<EOF > /usr/local/bin/ping-dns
      echo -e "\n ping dns ...\n"
      echo "contoso.com - \$(timeout 3 dig +short contoso.com | tail -n1) -\$(timeout 3 ping -qc2 -W1 contoso.com 2>&1 | awk -F'/' 'END{ print (/^rtt/? "OK "\$5" ms":"NA") }')"
      EOF
      chmod a+x /usr/local/bin/ping-dns
      
      # curl-ip
      
      cat <<EOF > /usr/local/bin/curl-ip
      echo -e "\n curl ip ...\n"
      echo  "\$(timeout 3 curl -kL --max-time 3.0 -H 'Cache-Control: no-cache' -w "%{http_code} (%{time_total}s) - %{remote_ip}" -s -o /dev/null contoso.com) - internet (contoso.com)"
      EOF
      chmod a+x /usr/local/bin/curl-ip
      
      # curl-dns
      
      cat <<EOF > /usr/local/bin/curl-dns
      echo -e "\n curl dns ...\n"
      echo  "\$(timeout 3 curl -kL --max-time 3.0 -H 'Cache-Control: no-cache' -w "%{http_code} (%{time_total}s) - %{remote_ip}" -s -o /dev/null contoso.com) - contoso.com"
      EOF
      chmod a+x /usr/local/bin/curl-dns
      
      # trace-ip
      
      cat <<EOF > /usr/local/bin/trace-ip
      echo -e "\n trace ip ...\n"
      echo -e "\ninternet"
      echo -e "-------------------------------------"
      timeout 9 tracepath contoso.com
      EOF
      chmod a+x /usr/local/bin/trace-ip
      
      # dns-info
      
      cat <<EOF > /usr/local/bin/dns-info
      echo -e "\n resolvectl ...\n"
      resolvectl status
      EOF
      chmod a+x /usr/local/bin/dns-info
      
      # azure service tester
      
      tee /usr/local/bin/crawlz <<'EOF'
      sudo bash -c "cd /var/lib/azure/crawler/app && ./crawler.sh"
      EOF
      chmod a+x /usr/local/bin/crawlz
      
      # light-traffic generator
      
      
      # heavy-traffic generator
      
      
      # crontab for traffic generators
      
      cat <<EOF > /tmp/crontab.txt
      EOF
      crontab /tmp/crontab.txt
      
  - path: /var/lib/azure/squid/docker-compose.yml
    owner: root
    permissions: 0744
    content: |
      version: '3.7'
      services:
        squid:
          container_name: squid
          image: ubuntu/squid:latest
          ports:
            - "3128:3128"
          network_mode: "host"
          volumes:
            - /etc/squid/squid.conf:/etc/squid/squid.conf
            - /etc/squid/blocked_sites:/etc/squid/blocked_sites
            - /var/log/squid/access.log:/var/log/squid/access.log
            - /var/log/squid/cache.log:/var/log/squid/cache.log
            - /var/log/squid/store.log:/var/log/squid/store.log
          restart: always
      
  - path: /var/lib/azure/squid/setup-squid.sh
    owner: root
    permissions: 0744
    content: |
      #!/bin/bash
      
      mkdir -p /var/log/squid
      touch /var/log/squid/access.log
      touch /var/log/squid/cache.log
      touch /var/log/squid/store.log
      chown proxy:proxy /var/log/squid/*
      chmod a+x /var/log/squid/*
      
  - path: /var/lib/azure/unbound/Dockerfile
    owner: root
    permissions: 0744
    content: |
      FROM alpine:3.19.0
      RUN apk add --no-cache unbound
      EXPOSE 53/tcp 53/udp
      CMD ["unbound", "-d"]
      
  - path: /var/lib/azure/unbound/docker-compose.yml
    owner: root
    permissions: 0744
    content: |
      version: '3'
      
      services:
        unbound:
          container_name: unbound
          build:
            context: .
            dockerfile: Dockerfile
          ports:
            - "53:53/tcp"
            - "53:53/udp"
          network_mode: "host"
          volumes:
            - /etc/unbound/unbound.log:/etc/unbound/unbound.log
            - /etc/unbound/unbound.conf:/etc/unbound/unbound.conf
          cap_add:
            - NET_ADMIN
          command: ["unbound", "-d"]
          restart: always
      
  - path: /var/lib/azure/unbound/setup-unbound.sh
    owner: root
    permissions: 0744
    content: |
      #! /bin/bash
      
      systemctl stop systemd-resolved
      systemctl disable systemd-resolved
      echo "nameserver 8.8.8.8" > /etc/resolv.conf
      echo "$(hostname -I | cut -d' ' -f1) $(hostname)" | tee -a /etc/hosts >/dev/null
      mkdir -p /etc/unbound
      touch /etc/unbound/unbound.log && chmod a+x /etc/unbound/unbound.log
      apt-get install -y resolvconf
      

runcmd:
  - . /var/lib/azure/init/server.sh
  - . /var/lib/azure/unbound/setup-unbound.sh
  - . /var/lib/azure/squid/setup-squid.sh
  - docker-compose -f /var/lib/azure/unbound/docker-compose.yml up -d
  - docker-compose -f /var/lib/azure/squid/docker-compose.yml up -d
  - python3 -m venv /var/lib/azure/crawler
